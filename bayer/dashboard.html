<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BAYER | HOME</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
	<link rel="stylesheet" type="text/css" href="1/style.css">
</head>
<body class="bgDark">
<div class="container">
	<header class="bgDark">
		<div class="card">		
			<div class="cover">
				<span class="material-symbols-outlined">person</span>
			</div>
			<div>
				<h2 id="nome">Nome</h2>
				<h3 id="matricula">0140000</h3>
			</div>
		</div>
		<div class="menu">	
				<a class="txtCorBr" href="home.html">				
					<span class="material-symbols-outlined">home</span>
				</a>
				<a class="txtCorBr" href="index.html"  onclick="sair()">				
					<span class="material-symbols-outlined">logout</span>
				</a>
		</div>
	</header>
	<h1 class="bgDark">DASHBOARD</h1>
	<div class="dash">
		<div class="info1 bgGrad" onclick="atualizar();">
			<h2 id="totalMasters">256</h2>
			<h6>MASTERS TRIADA(S)</h6>	
			<p class="txtcenter txtCorBr atualizacao">ULTIMA ATUALIZAÇÃO <b id="hora"></b></p>
		</div>			
		<div class="info1" id="top"></div>

		<div class="info1">
			<h3 class="txtCorBr txtcenter">ULTIMAS MASTERS LIDAS</h3>
			<div id="lidas"></div>
		</div>
	</div>
</div>

<script>	
var usuario = JSON.parse(localStorage.getItem("usuario")) || false;
	if(usuario!=false && usuario["dashboard"]){
		document.getElementById("nome").innerHTML = usuario["nome"];
		document.getElementById("matricula").innerHTML = usuario["matricula"];
	}else{
		window.location.href = "index.html";
	}
atualizar();
function atualizar(){
	var masters = JSON.parse(localStorage.getItem("tabelaMasters")) || [];

	document.getElementById('totalMasters').innerHTML = masters.length;
	var data = new Date();
	var minutos = data.getMinutes()<10 ? "0" + data.getMinutes() : data.getMinutes();
	document.getElementById('hora').innerHTML = data.getHours() + ":" + minutos;
	

	var ranking = [];
	for(var j in masters){
		var mat = masters[j]["usuario"]["matricula"];
		var nom = masters[j]["usuario"]["nome"];
		var total = 1;
		for(var k in ranking){
			if(ranking[k]["matricula"] == mat){
				ranking[k]["total"] += 1 ;
				total++;
			}
		}
		if(total==1){
		ranking.push({
				"nome": nom,
				"matricula": mat,
				"total": total
			});
	}
		
	}

	console.log("ranking");
	console.log(ranking);
	console.log("ranking");


	var top = document.getElementById('top');
	top.innerHTML = '<h3 class="txtcenter">TOP 3</h3>';
	if(ranking.length<3){
		top.innerHTML = '<h3 class="txtcenter">RANKING INDISPONIVEL</h3>';
	}else{
		for(var i = 0;i<3;i++){
			 top.innerHTML += estruturaTop(ranking[i]["nome"], ranking[i]["matricula"], ranking[i]["total"]);
		}
	}

		masters.sort(function (a,b){ //ordenar por data
			if(a.data > b.data){
				return -1;
			}
			if(a.data < b.data){
				return 1;
			}
			return 0;
		});

	console.log(masters);
	var lidas = document.getElementById('lidas');
	lidas.innerHTML = "";
	if(masters.length>0){
		for(var i in masters){
			var data = masters[i]["data"];
			lidas.innerHTML += estruturaLidas(masters[i]["master"], masters[i]["usuario"]["nome"], data);
		}
	}
}

function estruturaTop(nome, matricula, total){

return 	'<div class="info2">'
+	'	<div class="card">		'
+	'		<div class="cover">'
+	'			<span class="material-symbols-outlined">person</span>'
+	'		</div>'
+	'		<div>'
+	'			<h3>'+ nome +'</h3>'
+	'			<h6 class="txtCorBr">' + matricula +'</h6>'
+	'		</div>	'
+	'	</div>'
+	'	<div class="totalTriagem">'
+	'		<h5 class="txtCorBr">' + total +'</h5>'
+	'		<h3 class="txtCorBr">MASTERS</h3>'
+	'	</div>'
+	'</div>';

}


function estruturaLidas(codigo, nome, hora){

return  '		<div class="lida">'
+ '			<h3 class="txtcenter">' + codigo +'</h3>'
+ '			<div class="infoLida">'
+ '				<h4 class="txtcenter txtCorBr">' + nome + '</h4>'
+ '				<h4 class="txtcenter txtCorBr">' + hora +'</h4>'
+ '			</div>'
+ '		</div>'
+ '	</div>';

}

</script>
<script src="1/functions.js" type="text/javascript" charset="utf-8" async defer></script>
</body>
</html>